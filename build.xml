<project name="JastAdd2" default="build" xmlns:aspectj="antlib:org.aspectj">

	<property name="tools.dir"	value="tools"/>
	<taskdef uri="antlib:org.aspectj"
		classpath="${tools.dir}/aspectj-1.5.3/aspectjtools.jar"/>

	<description>Build script for JastAdd2</description>

	<taskdef name="jastadd" classname="jastadd.JastAddTask"
		classpath="${tools.dir}/jastadd2.jar"/>

	<target name="build-resources">
		<exec executable="svn" failonerror="false" output="svn.info">
			<arg value="info"/>
		</exec>
		<loadproperties srcfile="svn.info">
			<filterchain>
				<linecontains>
					<contains value="Revision"/>
				</linecontains>
			</filterchain>
		</loadproperties>
		<tstamp>
			<format property="build.date" pattern="yyyyMMdd"/>
		</tstamp>
		<property name="version.name" value="R${build.date}"/>
		<copy file="resources/JastAdd.txt" overwrite="true"
			toFile="JastAdd.properties">
			<filterset>
				<filter token="VERSION"
					value="${version.name} (r${Revision})"/>
			</filterset>
		</copy>
	</target>

	<target name="build" description="build JastAdd2"
		depends="build-resources">
		<jastadd java14="true" jjtree="true" rewrite="true"
			grammar="Ast" package="ast.AST" outdir="${basedir}"
			lazyMaps="false">
			<fileset dir="ast" includes="*.jrag,*.ast"/>
			<fileset dir="jrag" includes="*.jrag"/>
		</jastadd>
		<mkdir dir="ast/AST"/>
		<!-- Ast.jjt must be touched, or Ant will not run jjtree -->
		<touch file="ast/Ast.jjt"/>
		<java classpath="${tools.dir}/javacc.jar" classname="org.javacc.jjtree.Main">
			<arg value="-OUTPUT_DIRECTORY=${basedir}/ast/AST"/>
			<arg value="-NODE_PREFIX=&quot;&quot;"/>
			<arg value="${basedir}/ast/Ast.jjt"/>
		</java>
		<!-- NODE_PREFIX is not set correctly on Windows: -->
		<!--jjtree javacchome="${tools.dir}" nodeprefix="&quot;&quot;"
			outputdirectory="${basedir}/ast/AST"
			target="${basedir}/ast/Ast.jjt"/-->
		<javacc javacchome="${tools.dir}" jdkversion="1.4"
			outputdirectory="${basedir}/ast/AST"
			target="${basedir}/ast/AST/Ast.jj"/>
		<!-- Ast.jjt must be touched, or Ant will not run jjtree -->
		<touch file="jrag/Jrag.jjt"/>
		<jjtree javacchome="${tools.dir}"
			outputdirectory="${basedir}/jrag/AST"
			target="${basedir}/jrag/Jrag.jjt"/>
		<javacc javacchome="${tools.dir}" jdkversion="1.4"
			outputdirectory="${basedir}/jrag/AST"
			target="${basedir}/jrag/AST/Jrag.jj"/>
		<echo message="running AspectJ"/>
		<aspectj:iajc source="1.4">
			<classpath>
				<fileset dir="${tools.dir}/aspectj-1.5.3">
					<include name="*.jar"/>
				</fileset>
				<fileset dir="${tools.dir}">
					<include name="ant.jar"/>
					<include name="ant-launcher.jar"/>
				</fileset>
			</classpath>
			<src path="ast"/>
			<src path="jrag"/>
			<src path="jastadd"/>
		</aspectj:iajc>
		<echo message="done"/>
	</target>

	<target name="clean">
		<delete dir="ast/AST"/>
		<delete dir="test/ast"/>
		<delete file="JastAdd.properties"/>
		<delete file="test_results"/>
		<delete file="passed"/>
		<delete file="jrag/AST/Jrag.jj"/>
		<delete file="jrag/AST/TokenMgrError.java"/>
		<delete>
			<fileset dir="." includes="*.class"/>
			<fileset dir="ast" includes="*.class"/>
			<fileset dir="jastadd" includes="*.class"/>
			<fileset dir="test" includes="**/*.class"/>
			<fileset dir="jrag" includes="**/*.class"/>
			<filelist dir="jrag/AST">
			</filelist>
			<fileset dir="jrag/AST" includes="AST*"/>
			<fileset dir="jrag/AST" includes="JragParser*"/>
			<fileset dir="jrag/AST" includes="JJT*"/>
			<fileset dir="jrag/AST" includes="Node.*"/>
			<fileset dir="jrag/AST" includes="JavaCharStream*"/>
			<fileset dir="jrag/AST" includes="ParseException*"/>
		</delete>
	</target>

	<target name="test" depends="jar">
		<mkdir dir="test/ast"/>
		<javac srcdir="." includeantruntime="false">
			<include name="RunTests.java"/>
		</javac>
		<echo message="running unit tests"/>
		<java classpath="." classname="RunTests" output="test_results"
			logError="true"/>
		<echo message="tests completed, output written to test_results"/>
		<exec executable="grep" failonerror="true"
			output="passed">
			<arg value="test/Test[0-9]*\.java passed"/>
			<arg value="test_results"/>
		</exec>
		<exec executable="grep" failonerror="true"
			output="failed">
			<arg value="test/Test[0-9]*\.java failed"/>
			<arg value="test_results"/>
		</exec>
		<exec executable="diff" failonerror="true">
			<arg value="-qs"/>
			<arg value="passed"/>
			<arg value="test/shouldpass"/>
		</exec>
		<exec executable="diff" failonerror="true">
			<arg value="-qs"/>
			<arg value="failed"/>
			<arg value="test/shouldfail"/>
		</exec>
	</target>

	<target name="jar" depends="build"
		description="package binary distribution">
		<jar destfile="jastadd2.jar">
			<manifest>
				<attribute name="Main-Class" value="jastadd.JastAdd"/>
				<attribute name="Implementation-Title" value="JastAdd II"/>
				<attribute name="Implementation-Version"
					value="${version.name}"/>
				<attribute name="Implementation-Vendor"
					value="The JastAdd Team"/>
				<attribute name="Implementation-URL"
					value="http://jastadd.org"/>
			</manifest>
			<fileset dir=".">
				<include name="LICENSE"/>
				<include name="JastAdd.properties"/>
				<include name="ast/**/*.class"/>
				<include name="jastadd/*.class"/>
				<include name="jrag/**/*.class"/>
				<include name="org/aspectj/lang/*.class"/>
				<include name="org/aspectj/runtime/**/*.class"/>
			</fileset>
		</jar>
	</target>

	<target name="source-zip" depends="jar">
		<zip destfile="jastadd2-src.zip">
			<zipfileset dir="." prefix="jastadd2-src">
				<include name="LICENSE"/>
				<include name="README"/>
				<include name="jastadd2.jar"/>
				<include name="doc/reference-manual.html"/>
				<include name="doc/release-notes.html"/>
				<include name="RunTests.java"/>
				<include name="test/*"/>
				<exclude name="test/ast"/>
				<exclude name="test/*.class"/>
				<include name="jastadd/*.java"/>
				<include name="jastadd/*.jrag"/>
				<include name="jrag/*.java"/>
				<include name="jrag/*.jrag"/>
				<include name="jrag/*.jjt"/>
				<include name="jrag/AST/SimpleNode.java"/>
				<include name="jrag/AST/Token.java"/>
				<include name="ChangeLog"/>
				<include name="org/**/*.class"/>
				<include name="tools/**/*.jar"/>
				<include name="resources/*.txt"/>
				<include name="Makefile"/>
				<include name="build.xml"/>
				<include name="ast/*.java"/>
				<include name="ast/*.jrag"/>
				<include name="ast/*.jjt"/>
				<include name="ast/*.ast"/>
				<include name="ast/*.ast"/>
			</zipfileset>
		</zip>
	</target>

	<target name="bin-zip" depends="jar">
		<zip destfile="jastadd2-bin.zip">
			<zipfileset dir="." prefix="jastadd2-bin">
				<include name="LICENSE"/>
				<include name="jastadd2.jar"/>
				<include name="doc/reference-manual.html"/>
				<include name="doc/release-notes.html"/>
			</zipfileset>
		</zip>
	</target>

	<target name="release" depends="source-zip,bin-zip"
		description="build source-zip and bin-zip"/>

	<target name="bootstrap" depends="jar"
		description="Prepare JastAdd2 bootstrapping (copy jastadd2.jar to tools directory)">
		<copy file="jastadd2.jar" toDir="${tools.dir}"/>
	</target>
</project>
