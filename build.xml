<project name="JastAdd2" default="build">

	<property name="spec.dir" location="${basedir}"/>
	<property name="gen.dir" location="src/gen"/>
	<property name="bin.dir" location="bin"/>
	<property name="tools.dir" value="tools"/>

	<description>Build script for JastAdd2</description>

	<taskdef name="jastadd" classname="jastadd.JastAddTask"
		classpath="${tools.dir}/jastadd2.jar"/>

	<target name="build-resources">
		<mkdir dir="${gen.dir}"/>
		<echo message="Revision: -1" file="svn.info"/>
		<delete file="svn.info"/>
		<exec executable="svn" failonerror="false"
			failifexecutionfails="false" output="svn.info">
			<arg value="info"/>
		</exec>
		<loadproperties srcfile="svn.info">
			<filterchain>
				<linecontains>
					<contains value="Revision"/>
				</linecontains>
			</filterchain>
		</loadproperties>
		<tstamp>
			<format property="build.date" pattern="yyyyMMdd"/>
		</tstamp>
		<property name="version.name" value="R${build.date}"/>
		<copy file="resources/JastAdd.txt" overwrite="true"
			toFile="${gen.dir}/JastAdd.properties">
			<filterset>
				<filter token="VERSION"
					value="${version.name} (r${Revision})"/>
			</filterset>
		</copy>
	</target>

	<target name="build" description="generate sources and build JastAdd2"
		depends="build-resources">
		<mkdir dir="${gen.dir}/ast/AST"/>
		<mkdir dir="${gen.dir}/jrag/AST"/>
		<mkdir dir="${gen.dir}/jastadd"/>
		<mkdir dir="${bin.dir}"/>
		<copy todir="${gen.dir}/ast">
		  <fileset dir="${basedir}/ast">
		    <include name="**/*.java"/>
		  </fileset>
		</copy>
		<copy todir="${gen.dir}/jrag">
		  <fileset dir="${basedir}/jrag">
		    <include name="**/*.java"/>
		  </fileset>
		</copy>
		<copy todir="${gen.dir}/jastadd">
		  <fileset dir="${basedir}/jastadd">
		    <include name="**/*.java"/>
		  </fileset>
		</copy>
		<jastadd java14="true" jjtree="true" rewrite="true"
			grammar="Ast" package="ast.AST" outdir="${gen.dir}"
			lazyMaps="false">
			<fileset dir="ast" includes="*.jrag,*.jadd,*.ast"/>
		</jastadd>
		<mkdir dir="ast/AST"/>
		<!-- Ast.jjt must be touched, or Ant will not run jjtree -->
		<touch file="ast/Ast.jjt"/>
		<java classpath="${tools.dir}/javacc.jar" classname="org.javacc.jjtree.Main">
			<arg value="-OUTPUT_DIRECTORY=${gen.dir}/ast/AST"/>
			<arg value="-NODE_PREFIX=&quot;&quot;"/>
			<arg value="${spec.dir}/ast/Ast.jjt"/>
		</java>
		<!-- NODE_PREFIX is not set correctly on Windows: -->
		<!--jjtree javacchome="${tools.dir}" nodeprefix="&quot;&quot;"
			outputdirectory="${gen.dir}/ast/AST"
			target="${spec.dir}/ast/Ast.jjt"/-->
		<javacc javacchome="${tools.dir}" jdkversion="1.4"
			outputdirectory="${gen.dir}/ast/AST"
			target="${gen.dir}/ast/AST/Ast.jj"/>
		<!-- Ast.jjt must be touched, or Ant will not run jjtree -->
		<touch file="jrag/Jrag.jjt"/>
		<jjtree javacchome="${tools.dir}"
			outputdirectory="${gen.dir}/jrag/AST"
			target="${spec.dir}/jrag/Jrag.jjt"/>
		<javacc javacchome="${tools.dir}" jdkversion="1.4"
			outputdirectory="${gen.dir}/jrag/AST"
			target="${gen.dir}/jrag/AST/Jrag.jj"/>
		<javac destdir="${bin.dir}" source="1.4" includeantruntime="true">
			<src path="${gen.dir}"/>
		</javac>
		<copy todir="${bin.dir}">
			<fileset dir="${gen.dir}">
				<include name="**/*.properties"/>
			</fileset>
		</copy>
	</target>

	<target name="clean">
		<delete file="svn.info"/>
		<delete includeEmptyDirs="true">
			<fileset dir="${gen.dir}">
				<exclude name=".gitignore"/>
			</fileset>
		</delete>
		<delete dir="${bin.dir}"/>
	</target>

	<target name="jar" depends="build"
		description="package binary distribution">
		<jar destfile="jastadd2.jar">
			<manifest>
				<attribute name="Main-Class" value="jastadd.JastAdd"/>
				<attribute name="Implementation-Title" value="JastAdd II"/>
				<attribute name="Implementation-Version"
					value="${version.name}"/>
				<attribute name="Implementation-Vendor"
					value="The JastAdd Team"/>
				<attribute name="Implementation-URL"
					value="http://jastadd.org"/>
			</manifest>
			<fileset dir=".">
				<include name="LICENSE"/>
			</fileset>
			<fileset dir="${bin.dir}">
				<include name="**/*"/>
			</fileset>
		</jar>
	</target>

	<target name="source-zip" depends="jar">
		<zip destfile="jastadd2-src.zip">
			<zipfileset dir="." prefix="jastadd2-src">
				<include name="LICENSE"/>
				<include name="README.md"/>
				<include name="jastadd2.jar"/>
				<include name="doc/reference-manual.html"/>
				<include name="doc/release-notes.html"/>
				<include name="RunTests.java"/>
				<include name="jastadd/*.java"/>
				<include name="jastadd/*.jrag"/>
				<include name="jrag/*.java"/>
				<include name="jrag/*.jrag"/>
				<include name="jrag/*.jjt"/>
				<include name="jrag/AST/SimpleNode.java"/>
				<include name="jrag/AST/Token.java"/>
				<include name="ChangeLog"/>
				<include name="tools/**/*.jar"/>
				<include name="resources/*.txt"/>
				<include name="Makefile"/>
				<include name="build.xml"/>
				<include name="ast/*.java"/>
				<include name="ast/*.jrag"/>
				<include name="ast/*.jjt"/>
				<include name="ast/*.ast"/>
				<include name="ast/*.ast"/>
			</zipfileset>
		</zip>
	</target>

	<target name="bin-zip" depends="jar">
		<zip destfile="jastadd2-bin.zip">
			<zipfileset dir="." prefix="jastadd2-bin">
				<include name="LICENSE"/>
				<include name="jastadd2.jar"/>
				<include name="doc/reference-manual.html"/>
				<include name="doc/release-notes.html"/>
			</zipfileset>
		</zip>
	</target>

	<target name="release" description="build source-zip and bin-zip">
		<antcall target="clean"/>
		<antcall target="source-zip"/>
		<antcall target="bin-zip"/>
	</target>

	<target name="bootstrap" depends="jar"
		description="Prepare JastAdd2 bootstrapping (copy jastadd2.jar to tools directory)">
		<copy file="jastadd2.jar" toDir="${tools.dir}"/>
	</target>
</project>
